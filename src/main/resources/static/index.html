<!DOCTYPE html>
<head>
  <title>Vega Lite Bar Chart</title>
  <meta charset="utf-8">

  <script src="https://cdn.jsdelivr.net/npm/vega@3.2.1/build/vega.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@2.3.1/build/vega-lite.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@3.2.0/build/vega-embed.js"></script>

  <style media="screen">
    /* Add space between Vega-Embed links  */
    .vega-actions a {
      margin-right: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Template for Embedding Vega-Lite Visualization</h1>
  <!-- Container for the visuailzation -->
  <div id="vis"></div>

  <script>

  var vlSpec = {
      '$schema': 'https://vega.github.io/schema/vega-lite/v2.json',
      'data': { 'name': 'gapsData' },
      'layer': [
        {
          'mark': 'bar',
          'encoding': {
            'x': { 
              'field': 'timestamp', 
              'type': 'temporal',
              'timeUnit': 'milliseconds'
            },
            'y': { 
              'field': 'gapValue', 
              'type': 'quantitative',
              'axis': {
                'grid': false
              }
            }
          }
        },
        {
          'mark': 'line',
          'encoding': {
            'x': { 
              'field': 'timestamp',
              'type': 'temporal',
              'timeUnit': 'milliseconds'
            },
            'y': { 
              'field': 'volume', 
              'type': 'quantitative', 
              'axis': {
                'grid': false
              },
              'scale': { 
                'zero': false 
              }
            },
            'color': {
              'value': 'firebrick'
            }
          }
        }
      ],
      'resolve': {
        'scale': {
          'y': 'independent'
        }
      },
      'width': 800,
      'height': 600
      // 'facet': {
      //     'row': {
      //       'field': 'symbol',
      //       'type': 'nominal'
      //     }
      //   },
      // 'spec': {
        // 'height': 400,
      // }
      
  };
  vegaEmbed('#vis', vlSpec).then(function(res) {
      var data = null;
      var minX = [];
      var counter = 0;
      function newGenerator() {
          return function () {
            var timestamp = data.timestamp;
            console.log("timestamp: " + timestamp);
            var gapValue = Object.keys(data.gapLevels)[0];
            console.log("gapValue: " + gapValue);
            var symbol = data.baseCurrency + data.counterCurrency;
            console.log("symbol: " + symbol);
            var volume = data.gapLevels[gapValue].volume;
            console.log("volume: " + volume);
            minX.push(timestamp);
            counter++;
            return {
              timestamp: timestamp,
              gapValue: gapValue,
              symbol: symbol,
              volume: volume
            }; 
          };
      }

      var valueGenerator = newGenerator();

      var gapsSocket = new WebSocket("ws://localhost:8080/gaps");
      gapsSocket.onmessage = function (event) {
        data = JSON.parse(event.data);
        console.log("INCOMING EVENT...");
        console.log(data);

        var changeSet = vega.changeset()
          .insert(valueGenerator())
          .remove(function (t) { 
            if (counter > 500) {
              return t.x < minX.shift();
            } else {
              return false;
            }
          });
        res.view.change('gapsData', changeSet).run();
      }
        
  });

  /*
  // Assign the specification to a local variable vlSpec.
  var vlSpec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v2.json",
    "data": {
      "name": "gapsData"
    },
    "mark": "bar",
    "encoding": {
      "x": {"field": "timestamp", "type": "quantitative"},
      "y": {
        "field": "timegap", "type": "quantitative",
        "axis": {
          "title": "timegap values"
        }
      }
    }
  };

  // Embed the visualization in the container with id `vis`
  vegaEmbed("#vis", vlSpec).then(function(res) {
    var gapsSocket = new WebSocket("ws://localhost:8080/gaps");
    
    var minTimestamp = Date.now();
    console.log(minTimestamp);
    console.log(new Date(minTimestamp).toISOString());
    console.log("Receiving websocket events...");
    gapsSocket.onmessage = function (event) {
      console.log(event.data);
      var insert = {timestamp: 1521500464, timegap: 0.5};
      console.log(insert);
      
      var changeSet = vega.changeset().insert(function() {
        return insert;
        //return {timestamp: event.data.timestamp, timegap: event.data.timegap};
      }).remove(function (t) { 
        return false;
        // return new Date(t.timestamp).getTime() > minTimestamp; 
      });
      
      res.view.change('gapsData', changeSet).run();
      minTimestamp = new Date(event.data.timestamp).getTime();
    }
  });
  */
  </script>
</body>
</html>